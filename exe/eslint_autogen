#!/usr/bin/env ruby
# frozen_string_literal: true

require "active_support/all"
require "stringio"

TODO_FILE_PATH = "./.eslint_todo.ts"
HEADING = <<~COMMENTS.freeze
  // This configuration was generated by `exe/eslint_autogen`
  // on #{Time.now.utc}.
  // The point is for the user to remove these configuration records
  // one by one as the offenses are removed from the code base.
COMMENTS

File.write(TODO_FILE_PATH, "export default []")
json = `pnpm --silent eslint --format json`
results = JSON.parse(json)

by_rule =
  results.each_with_object({}) do |result, hash|
    result.fetch("messages").each do |message|
      rule_id = message.fetch("ruleId")
      next if rule_id.nil?

      hash[rule_id] ||= []
      hash[rule_id] << result.fetch("filePath")
    end
  end

output = StringIO.new
output.puts(HEADING)
output.puts
output.puts("export default [")

by_rule.sort.each do |rule, file_paths|
  output.puts("  // Offense count: #{file_paths.length}")
  output.puts("  {")
  output.puts("    files: [")

  file_paths.uniq.sort.each do |file_path|
    relative_path = file_path.sub("#{Dir.pwd}/", "")
    output.puts("      \"#{relative_path}\",")
  end

  output.puts("    ],")
  output.puts("    rules: {")
  output.puts("      \"#{rule}\": \"off\",")
  output.puts("    },")
  output.puts("  },")
end

output.puts("];")

File.write(TODO_FILE_PATH, output.string)
