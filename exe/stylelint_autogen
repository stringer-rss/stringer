#!/usr/bin/env ruby
# frozen_string_literal: true

require "active_support/all"
require "stringio"

TODO_FILE_PATH = "./.stylelint_todo.yml"
HEADING = <<~COMMENTS.freeze
  # This configuration was generated by `exe/stylelint_autogen`
  # on #{Time.now.utc}.
  # The point is for the user to remove these configuration records
  # one by one as the offenses are removed from the code base.
COMMENTS

File.write(TODO_FILE_PATH, "{}")
json =
  `pnpm --silent stylelint --quiet-deprecation-warnings --formatter json 2>&1`
results = JSON.parse(json)

by_rule =
  results.each_with_object({}) do |result, hash|
    result.fetch("warnings").each do |warning|
      hash[warning.fetch("rule")] ||= []
      hash[warning.fetch("rule")] << result.fetch("source")
    end
  end

output = StringIO.new
output.puts(HEADING)
output.puts
output.puts("overrides:")

by_rule.sort.each do |rule, file_paths|
  output.puts
  output.puts("  # Offense count: #{file_paths.length}")
  output.puts("  - rules: { '#{rule}': null }")
  output.puts("    files:")

  file_paths.uniq.sort.each do |file_path|
    output.puts("    - #{file_path.sub("#{Dir.pwd}/", "")}")
  end
end

File.write(TODO_FILE_PATH, output.string)
